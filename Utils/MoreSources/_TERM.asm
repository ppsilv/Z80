;
	ORG	#8000
;
	LD	A,2
	CALL	#1601
	DI
	LD	A,1
	OUT	(#F7),A
	LD	A,1
	OUT	(#F7),A
	LD	A,#40
	OUT	(#F7),A
	LD	A,#4E
	OUT	(#F7),A
;
MAINLOOP
	LD	A,#16
	OUT	(#F7),A
	CALL	RXBLOCK
	CALL	PRINTBLOCK
	LD	A,#33
	OUT	(#F7),A
	CALL	READLN
	CALL	TXBLOCK
	JR	MAINLOOP
;
RXBLOCK
	DI
	LD	HL,#C000
R1
	LD	A,#16
	OUT	(#F7),A
	CALL	RXBYTE
	OR	A
	JR	NZ,R1
R2
	LD	A,#16
	OUT	(#F7),A
	CALL	RXBYTE
	OR	A
	JR	Z,R2
	JR	R3
;
RXBLOCK1
	LD	A,#16
	OUT	(#F7),A
	CALL	RXBYTE
R3
	LD	(HL),A
	INC	HL
	CP	#1A
	JR	NZ,RXBLOCK1
	EI
	RET
;
PRINTBLOCK
	LD	HL,#C000
PRINTBLOCK1
	LD	A,(HL)
	CP	#1A
	RET	Z
	CP	13
	JR	Z,RST
	CP	32
	JR	C,RST2
RST
	RST	#10
RST2
	INC	HL
	JR	PRINTBLOCK1
;
RXBYTE
	CALL	#1F54
	JR	NC,BREAK
	IN	A,(#F7)
	AND	#38
	JR	NZ,RXBYTE1
	IN	A,(#F7)
	BIT	1,A
	JR	Z,RXBYTE
RXBYTE1
	IN	A,(#77)
	RET
BREAK
	XOR	A
	OUT	(#F7),A
	EI
	RST	8
	DEFB	13
;
READLN
	LD	HL,#C000
READLN1
	CALL	GETKBD
	CP	#0D
	JR	Z,READLN_CR
	CP	#8
	JR	Z,READLN_BS
	CP	#20
	JR	C,READLN1
	LD	(HL),A
	INC	HL
	RST	#10
	JR	READLN1
READLN_CR
	LD	(HL),A
	INC	HL
	LD	(HL),#1A
	JP	#10
READLN_BS
	LD	A,L
	OR	A
	JR	NZ,READLN_BS1
	LD	A,H
	CP	#C0
	JR	Z,READLN1
READLN_BS1
	DEC	HL
	LD	A,8
	RST	#10
	LD	A," "
	RST	#10
	LD	A,8
	RST	#10
	JR	READLN1
;
TXBLOCK
	DI
	LD	HL,#C000
	LD	B,16
T1
	LD	A,#33
	OUT	(#F7),A
	XOR	A
	CALL	TXBYTE
	DJNZ	T1
;
TXBLOCK1
	LD	A,#33
	OUT	(#F7),A
	LD	A,(HL)
	CALL	TXBYTE
	INC	HL
	CP	#1A
	JR	NZ,TXBLOCK1
	CALL	TXBYTE
	CALL	TXBYTE
	CALL	TXBYTE
	CALL	TXBYTE
	CALL	TXBYTE
	CALL	TXBYTE
	CALL	TXBYTE
	EI
	RET
;
TXBYTE
	PUSH	AF
TXBYTE1
	CALL	#1F54
	JR	NC,BREAK
	IN	A,(#F7)
	BIT	0,A
	JR	Z,TXBYTE1
	POP	AF
	OUT	(#77),A
	RET
GETKBD
	EI
	RES	5,(IY+1)
GETKBD1
	BIT	5,(IY+1)
	JR	Z,GETKBD1
	CALL	#1F54
	JP	NC,BREAK
	LD	A,(IY-50)
	RES	5,(IY+1)
	RET
;
EOF

